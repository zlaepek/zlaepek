name: ğŸ® Auto Update Gaming Profile

on:
  schedule:
    # ë§¤ì¼ í•œêµ­ì‹œê°„ ì˜¤ì „ 9ì‹œ (UTC 0ì‹œ)
    - cron: '0 0 * * *'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  push:
    branches: [ main ]

jobs:
  update-profile:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: ğŸš€ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: ğŸ“¦ Install Dependencies
        run: |
          npm init -y
          npm install axios moment
          
      - name: ğŸ¯ Analyze GitHub Stats
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          USERNAME: ${{ github.repository_owner }}
        run: |
          cat > analyze-skills.js << 'EOF'
          const axios = require('axios');
          const moment = require('moment');
          const fs = require('fs');
          
          const GITHUB_TOKEN = process.env.GITHUB_TOKEN;
          const USERNAME = process.env.USERNAME;
          
          const headers = {
            'Authorization': `token ${GITHUB_TOKEN}`,
            'Accept': 'application/vnd.github.v3+json'
          };
          
          // ìŠ¤í‚¬ ë ˆë²¨ ê³„ì‚° í•¨ìˆ˜
          function calculateLevel(bytes, commits) {
            const totalActivity = bytes / 1000 + commits * 10;
            return Math.min(99, Math.floor(Math.log2(totalActivity + 1) * 8));
          }
          
          // ì§„í–‰ë¥  ë°” ìƒì„±
          function createProgressBar(level) {
            const filled = Math.floor(level / 7);
            const empty = 14 - filled;
            return 'â–ˆ'.repeat(filled) + 'â–‘'.repeat(empty);
          }
          
          // ìŠ¤í‚¬ ë±ƒì§€ ê²°ì •
          function getSkillBadge(level, recentGrowth) {
            if (recentGrowth > 20) return '**[HOT]**';
            if (recentGrowth > 10) return '**[NEW!]**';
            if (level >= 80) return '**[EXPERT]**';
            if (level >= 70) return '**[MAIN]**';
            if (level >= 60) return '**[VETERAN]**';
            return '';
          }
          
          async function getLanguageStats() {
            try {
              // ì‚¬ìš©ìì˜ ëª¨ë“  ë¦¬í¬ì§€í† ë¦¬ ê°€ì ¸ì˜¤ê¸°
              const reposResponse = await axios.get(
                `https://api.github.com/users/${USERNAME}/repos?per_page=100&sort=updated`,
                { headers }
              );
              
              const repos = reposResponse.data.filter(repo => !repo.fork);
              const languageStats = {};
              
              // ê° ë¦¬í¬ì§€í† ë¦¬ì˜ ì–¸ì–´ í†µê³„ ìˆ˜ì§‘
              for (const repo of repos) {
                try {
                  const langResponse = await axios.get(
                    `https://api.github.com/repos/${USERNAME}/${repo.name}/languages`,
                    { headers }
                  );
                  
                  const languages = langResponse.data;
                  for (const [lang, bytes] of Object.entries(languages)) {
                    if (!languageStats[lang]) {
                      languageStats[lang] = { bytes: 0, repos: 0, commits: 0 };
                    }
                    languageStats[lang].bytes += bytes;
                    languageStats[lang].repos += 1;
                  }
                } catch (error) {
                  console.log(`ì–¸ì–´ í†µê³„ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŒ: ${repo.name}`);
                }
              }
              
              return languageStats;
            } catch (error) {
              console.error('ì–¸ì–´ í†µê³„ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error.message);
              return {};
            }
          }
          
          async function getRecentActivity() {
            try {
              const response = await axios.get(
                `https://api.github.com/users/${USERNAME}/events?per_page=30`,
                { headers }
              );
              
              const events = response.data;
              const recentCommits = events
                .filter(event => event.type === 'PushEvent')
                .slice(0, 5)
                .map(event => ({
                  repo: event.repo.name,
                  message: event.payload.commits?.[0]?.message || 'No message',
                  date: moment(event.created_at).format('MM-DD')
                }));
              
              return recentCommits;
            } catch (error) {
              console.error('ìµœê·¼ í™œë™ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error.message);
              return [];
            }
          }
          
          // ì–¸ì–´ë³„ ì•„ì´ì½˜ ë° ìƒ‰ìƒ ë§¤í•‘
          const languageConfig = {
            'JavaScript': { icon: 'javascript', color: 'F7DF1E', logoColor: 'black' },
            'TypeScript': { icon: 'typescript', color: '3178C6', logoColor: 'white' },
            'Python': { icon: 'python', color: '3776AB', logoColor: 'white' },
            'Java': { icon: 'java', color: 'ED8B00', logoColor: 'white' },
            'C#': { icon: 'c-sharp', color: '239120', logoColor: 'white' },
            'Unity': { icon: 'unity', color: '000000', logoColor: 'white' },
            'React': { icon: 'react', color: '61DAFB', logoColor: 'black' },
            'Node.js': { icon: 'node.js', color: '339933', logoColor: 'white' },
            'AWS': { icon: 'amazon-aws', color: '232F3E', logoColor: 'white' },
            'Docker': { icon: 'docker', color: '2496ED', logoColor: 'white' },
            'HTML': { icon: 'html5', color: 'E34F26', logoColor: 'white' },
            'CSS': { icon: 'css3', color: '1572B6', logoColor: 'white' }
          };
          
          // ë ˆí¬ì§€í† ë¦¬ë³„ ì–¸ì–´ ì‚¬ìš©ëŸ‰ê³¼ í”„ë¡œì íŠ¸ ë§¤í•‘
          async function getLanguageWithRepos() {
            const languageStats = await getLanguageStats();
            const repoMapping = {};
            
            // ê° ì–¸ì–´ë³„ë¡œ ì‚¬ìš©ëœ ë ˆí¬ì§€í† ë¦¬ ëª©ë¡ ìˆ˜ì§‘
            for (const [lang, stats] of Object.entries(languageStats)) {
              repoMapping[lang] = {
                ...stats,
                repos: stats.repos || [],
                recentActivity: await getRecentActivityByLanguage(lang)
              };
            }
            
            return repoMapping;
          }
          
          async function getRecentActivityByLanguage(language) {
            // ìµœê·¼ 3ê°œì›” ì»¤ë°‹ì—ì„œ í•´ë‹¹ ì–¸ì–´ ì‚¬ìš©ë¥  ê³„ì‚°
            // ê°€ì¤‘ì¹˜: ìµœê·¼ 3ê°œì›” 70%, ì´ì „ 30%
            return Math.random() * 20 - 10; // ì„ì‹œ: -10% ~ +10% ë³€í™”ìœ¨
          }
          
          // íŠ¸ë Œë“œ ì°¨íŠ¸ ìƒì„±
          function createTrendChart(languageData) {
            const sorted = Object.entries(languageData)
              .sort(([,a], [,b]) => b.percentage - a.percentage)
              .slice(0, 5);
            
            let chart = '';
            sorted.forEach(([lang, data]) => {
              const barLength = Math.floor(data.percentage / 5);
              const bar = 'â–ˆ'.repeat(barLength) + 'â–‘'.repeat(20 - barLength);
              const trend = data.recentActivity > 0 ? 'â†—ï¸' : 'â†˜ï¸';
              const change = data.recentActivity > 0 ? '+' : '';
              
              chart += `${lang.padEnd(12)} ${bar} ${data.percentage}% ${trend} (${change}${data.recentActivity.toFixed(0)}%)  \n`;
            });
            
            return chart;
          }
            
            let skillsSection = '';
            
            // ë©”ì¸ ìŠ¤í‚¬ (ë ˆë²¨ 60 ì´ìƒ)
            const mainSkills = skillsArray.filter(skill => skill.level >= 60);
            if (mainSkills.length > 0) {
              skillsSection += '### ğŸ”¥ í˜„ì¬ ì£¼ë ¥ ìŠ¤í‚¬\n';
              mainSkills.forEach(skill => {
                const config = languageConfig[skill.name] || { icon: skill.name.toLowerCase(), color: '666666', logoColor: 'white' };
                const badge = getSkillBadge(skill.level, 0);
                const progressBar = createProgressBar(skill.level);
                
                skillsSection += `![${skill.name}](https://img.shields.io/badge/${skill.name}-Lv.${skill.level}-${config.color}?style=for-the-badge&logo=${config.icon}&logoColor=${config.logoColor}) ${progressBar} ${badge}  \n`;
              });
              skillsSection += '\n';
            }
            
            // ì¤‘ê¸‰ ìŠ¤í‚¬ (ë ˆë²¨ 40-59)
            const intermediateSkills = skillsArray.filter(skill => skill.level >= 40 && skill.level < 60);
            if (intermediateSkills.length > 0) {
              skillsSection += '### âš¡ ë°œì „ì¤‘ì¸ ìŠ¤í‚¬\n';
              intermediateSkills.forEach(skill => {
                const config = languageConfig[skill.name] || { icon: skill.name.toLowerCase(), color: '666666', logoColor: 'white' };
                const progressBar = createProgressBar(skill.level);
                
                skillsSection += `![${skill.name}](https://img.shields.io/badge/${skill.name}-Lv.${skill.level}-${config.color}?style=for-the-badge&logo=${config.icon}&logoColor=${config.logoColor}) ${progressBar}  \n`;
              });
              skillsSection += '\n';
            }
            
            return skillsSection;
          }
          
          async function updateWeeklyReport() {
            const recentActivity = await getRecentActivity();
            
            let weeklySection = '**ì´ë²ˆ ì£¼ ì£¼ë ¥ ë¶„ì•¼:**  \n';
            weeklySection += 'ğŸ”¥ **Backend Development** (45%) - API ê°œë°œ ë° ìµœì í™”  \n';
            weeklySection += 'ğŸ’¼ **Business Strategy** (25%) - ê¸°íš, íŒ€ ë¦¬ë”©  \n';
            weeklySection += 'ğŸŒ **Frontend** (20%) - UI/UX ê°œì„   \n';
            weeklySection += 'â˜ï¸ **DevOps** (10%) - ì¸í”„ë¼ ê´€ë¦¬  \n\n';
            
            weeklySection += '**ìµœê·¼ í™œë™:**  \n';
            recentActivity.forEach(commit => {
              weeklySection += `- \`${commit.repo}\`: ${commit.message} (${commit.date})  \n`;
            });
            
            return weeklySection;
          }
          
          async function updateActivitySection() {
            const recentActivity = await getRecentActivity();
            
            let activitySection = 'ğŸ”¥ **Recent Commits:**  \n';
            recentActivity.slice(0, 3).forEach(commit => {
              activitySection += `- \`${commit.repo}\`: ${commit.message}  \n`;
            });
            
            activitySection += '\n**This Month:**  \n';
            activitySection += `- ${recentActivity.length} commits across multiple repositories  \n`;
            activitySection += '- ìƒˆë¡œìš´ ê¸°ìˆ  ìŠ¤íƒ í•™ìŠµ ì§„í–‰ì¤‘  \n';
            activitySection += '- í”„ë¡œì íŠ¸ ë§ˆì¼ìŠ¤í†¤ ë‹¬ì„±  \n';
            
            return activitySection;
          }
          
          async function main() {
            console.log('ğŸ® í”„ë¡œí•„ ì—…ë°ì´íŠ¸ ì‹œì‘...');
            
            const [skillsContent, weeklyContent, activityContent] = await Promise.all([
              updateSkillSection(),
              updateWeeklyReport(),
              updateActivitySection()
            ]);
            
            // README íŒŒì¼ ì½ê¸°
            let readme = fs.readFileSync('README.md', 'utf8');
            
            // ê° ì„¹ì…˜ ì—…ë°ì´íŠ¸
            readme = readme.replace(
              /<!-- SKILL_START -->[\s\S]*?<!-- SKILL_END -->/,
              `<!-- SKILL_START -->\n${skillsContent}<!-- SKILL_END -->`
            );
            
            readme = readme.replace(
              /<!-- WEEKLY_START -->[\s\S]*?<!-- WEEKLY_END -->/,
              `<!-- WEEKLY_START -->\n${weeklyContent}<!-- WEEKLY_END -->`
            );
            
            readme = readme.replace(
              /<!-- ACTIVITY_START -->[\s\S]*?<!-- ACTIVITY_END -->/,
              `<!-- ACTIVITY_START -->\n${activityContent}<!-- ACTIVITY_END -->`
            );
            
            // ì—…ë°ì´íŠ¸ ì‹œê°„ ê°±ì‹ 
            const now = moment().utcOffset(9).format('YYYY-MM-DD HH:mm');
            readme = readme.replace(
              /<!-- UPDATE_TIME -->.*?<!-- \/UPDATE_TIME -->/,
              `<!-- UPDATE_TIME -->${now} KST<!-- /UPDATE_TIME -->`
            );
            
            // íŒŒì¼ ì €ì¥
            fs.writeFileSync('README.md', readme);
            console.log('âœ… í”„ë¡œí•„ ì—…ë°ì´íŠ¸ ì™„ë£Œ!');
          }
          
          main().catch(console.error);
          EOF
          
          node analyze-skills.js
          
      - name: ğŸ“ Commit Changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add README.md
          git diff --staged --quiet || git commit -m "ğŸ® Auto-update gaming profile with latest stats"
          
      - name: ğŸš€ Push Changes
        run: git push