name: Auto Update Profile

on:
  schedule:
    # ë§¤ì›” 1ì¼ í•œêµ­ì‹œê°„ ì˜¤ì „ 9ì‹œ (UTC 0ì‹œ)
    - cron: '0 0 1 * *'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_run:
    workflows: ["Generate Language Trend Charts"]
    types:
      - completed
  push:
    branches: [ main ]
    paths:
      - 'activity.json'

jobs:
  update-profile:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule' }}
    permissions:
      contents: write
      
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Install Dependencies
        run: |
          npm init -y
          npm install axios moment
          
      - name: Analyze GitHub Stats
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          USERNAME: ${{ github.repository_owner }}
        run: |
          cat > analyze-skills.js << 'EOF'
          const axios = require('axios');
          const moment = require('moment');
          const fs = require('fs');
          
          const GITHUB_TOKEN = process.env.GITHUB_TOKEN;
          const USERNAME = process.env.USERNAME;
          
          const headers = {
            'Authorization': `token ${GITHUB_TOKEN}`,
            'Accept': 'application/vnd.github.v3+json'
          };
          
          // ìŠ¤í‚¬ ë ˆë²¨ ê³„ì‚° í•¨ìˆ˜
          function calculateLevel(lines, commits) {
            const totalActivity = lines / 100 + commits * 10;
            return Math.min(99, Math.floor(Math.log2(totalActivity + 1) * 8));
          }
          
          // ì§„í–‰ë¥  ë°” ìƒì„± (shields.io ìŠ¤íƒ€ì¼)
          function createProgressBar(level) {
            const percentage = Math.min(100, level);
            let color = '90EE90'; // ê¸°ë³¸ ì´ˆë¡
            
            if (percentage >= 80) color = 'FFD700'; // ê¸ˆìƒ‰
            else if (percentage >= 60) color = 'C0C0C0'; // ì€ìƒ‰  
            else if (percentage >= 40) color = 'CD7F32'; // ë™ìƒ‰
            
            return `![Progress](https://img.shields.io/badge/Progress-${percentage}%25-${color}?style=flat&logo=chartdotjs&logoColor=white)`;
          }
          
          // ë­í¬ ë±ƒì§€ ê²°ì •
          function getRankBadge(level) {
            if (level >= 80) return {
              text: 'MASTER',
              icon: 'ğŸ¥‡',
              color: 'FFD700'
            };
            if (level >= 60) return {
              text: 'PRO',
              icon: 'ğŸ¥ˆ',
              color: 'C0C0C0'
            };
            if (level >= 40) return {
              text: 'LEARNING',
              icon: 'ğŸ¥‰',
              color: 'CD7F32'
            };
            return {
              text: 'STARTER',
              icon: 'ğŸ…',
              color: '90EE90'
            };
          }

          // ìŠ¤í‚¬ ë ˆë²¨ì— ë”°ë¥¸ í…ìŠ¤íŠ¸ ê²°ì •
          function getSkillLevel(level) {
            if (level >= 80) return 'Master';
            if (level >= 60) return 'Pro';
            if (level >= 40) return 'Learning';
            return 'Starter';
          }
          
          async function getLanguageStats() {
            try {
              // ì‚¬ìš©ìì˜ ëª¨ë“  ë¦¬í¬ì§€í† ë¦¬ ê°€ì ¸ì˜¤ê¸° (ë¹„ê³µê°œ í¬í•¨)
              const reposResponse = await axios.get(
                `https://api.github.com/user/repos?per_page=100&sort=updated&type=all`,
                { headers }
              );
              
              const repos = reposResponse.data.filter(repo => !repo.fork);
              const languageStats = {};
              
              // ê° ë¦¬í¬ì§€í† ë¦¬ì˜ ì–¸ì–´ í†µê³„ ìˆ˜ì§‘
              for (const repo of repos) {
                try {
                  const langResponse = await axios.get(
                    `https://api.github.com/repos/${USERNAME}/${repo.name}/languages`,
                    { headers }
                  );
                  
                  const languages = langResponse.data;
                  for (const [lang, bytes] of Object.entries(languages)) {
                    if (!languageStats[lang]) {
                      languageStats[lang] = { lines: 0, repos: 0, commits: 0 };
                    }
                    // ë°”ì´íŠ¸ë¥¼ ì¤„ ìˆ˜ë¡œ ë³€í™˜ (50ë°”ì´íŠ¸ â‰ˆ 1ì¤„)
                    const estimatedLines = Math.floor(bytes / 50);
                    languageStats[lang].lines += estimatedLines;
                    languageStats[lang].repos += 1;
                  }
                } catch (error) {
                  console.log(`ì–¸ì–´ í†µê³„ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŒ: ${repo.name}`);
                }
              }
              
              return languageStats;
            } catch (error) {
              console.error('ì–¸ì–´ í†µê³„ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error.message);
              return {};
            }
          }
          
          async function getRecentActivity() {
            try {
              const response = await axios.get(
                `https://api.github.com/users/${USERNAME}/events?per_page=30`,
                { headers }
              );
              
              const events = response.data;
              const recentCommits = events
                .filter(event => event.type === 'PushEvent')
                .slice(0, 5)
                .map(event => ({
                  repo: event.repo.name,
                  message: event.payload.commits?.[0]?.message || 'No message',
                  date: moment(event.created_at).format('MM-DD')
                }));
              
              return recentCommits;
            } catch (error) {
              console.error('ìµœê·¼ í™œë™ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error.message);
              return [];
            }
          }
          
          // ì–¸ì–´ë³„ ì•„ì´ì½˜ ë° ìƒ‰ìƒ ë§¤í•‘ (ë¶„ì•¼ë³„ ìƒ‰ìƒ ì½”ë”©)
          const languageConfig = {
            // ì›¹ í”„ë¡ íŠ¸ì—”ë“œ (í•‘í¬ê³„ì—´)
            'JavaScript': { icon: 'javascript', color: 'FF69B4', logoColor: 'white' },
            'TypeScript': { icon: 'typescript', color: 'FF1493', logoColor: 'white' },
            'React': { icon: 'react', color: 'FFB3D9', logoColor: 'white' },
            'HTML': { icon: 'html5', color: 'FFB6C1', logoColor: 'white' },
            'CSS': { icon: 'css3', color: 'FFC0CB', logoColor: 'black' },

            // ìœ ë‹ˆí‹°/ê²Œì„ (ë³´ë¼ê³„ì—´ - ë©”ì¸)
            'C#': { icon: 'c-sharp', color: '7469B6', logoColor: 'white' },
            'Unity': { icon: 'unity', color: '7469B6', logoColor: 'white' },

            // ë°±ì—”ë“œ (ë¸”ë£¨ê³„ì—´)
            'Java': { icon: 'java', color: '4A90E2', logoColor: 'white' },
            'Python': { icon: 'python', color: '74C0FC', logoColor: 'white' },
            'Node.js': { icon: 'node.js', color: '6495ED', logoColor: 'white' },
            'AWS': { icon: 'amazon-aws', color: '87CEEB', logoColor: 'white' },

            // DevOps/ê¸°íƒ€
            'Docker': { icon: 'docker', color: '2496ED', logoColor: 'white' }
          };
          
          // ë ˆí¬ì§€í† ë¦¬ë³„ ì–¸ì–´ ì‚¬ìš©ëŸ‰ê³¼ í”„ë¡œì íŠ¸ ë§¤í•‘
          async function getLanguageWithRepos() {
            const languageStats = await getLanguageStats();
            const repoMapping = {};
            
            // ê° ì–¸ì–´ë³„ë¡œ ì‚¬ìš©ëœ ë ˆí¬ì§€í† ë¦¬ ëª©ë¡ ìˆ˜ì§‘
            for (const [lang, stats] of Object.entries(languageStats)) {
              repoMapping[lang] = {
                ...stats,
                repos: stats.repos || [],
                recentActivity: await getRecentActivityByLanguage(lang)
              };
            }
            
            return repoMapping;
          }
          
          async function getRecentActivityByLanguage(language) {
            // ìµœê·¼ 3ê°œì›” ì»¤ë°‹ì—ì„œ í•´ë‹¹ ì–¸ì–´ ì‚¬ìš©ë¥  ê³„ì‚°
            // ê°€ì¤‘ì¹˜: ìµœê·¼ 3ê°œì›” 70%, ì´ì „ 30%
            return Math.random() * 20 - 10; // ì„ì‹œ: -10% ~ +10% ë³€í™”ìœ¨
          }
          
          async function updateSkillSection() {
            const languageStats = await getLanguageStats();

            // ì–¸ì–´ë³„ í†µê³„ë¥¼ ë ˆë²¨ë¡œ ë³€í™˜ (ì œì™¸í•  ì–¸ì–´ í•„í„°ë§)
            const excludeLanguages = ['ShaderLab', 'HLSL', 'Makefile', 'Batchfile', 'Shell'];
            let skillsArray = Object.entries(languageStats)
              .filter(([name]) => !excludeLanguages.includes(name))
              .map(([name, stats]) => ({
                name,
                level: calculateLevel(stats.lines, stats.repos),
                lines: stats.lines,
                repos: stats.repos
              }))
              .sort((a, b) => b.level - a.level)
              .slice(0, 6); // ìƒìœ„ 6ê°œë§Œ í‘œì‹œ

            // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ ìŠ¤í‚¬ ì¶”ê°€
            if (skillsArray.length === 0) {
              skillsArray = [
                { name: 'C#', level: 62 },
                { name: 'JavaScript', level: 45 }
              ];
            }

            let skillsSection = '';

            if (skillsArray.length > 0) {
              // í…Œì´ë¸” ì‹œì‘
              skillsSection += '<table width="100%">\n';
              skillsSection += '  <thead>\n';
              skillsSection += '    <tr>\n';
              skillsSection += '      <th width="70%">ê¸°ìˆ  ìŠ¤íƒ</th>\n';
              skillsSection += '      <th width="30%">ìˆ™ë ¨ë„</th>\n';
              skillsSection += '    </tr>\n';
              skillsSection += '  </thead>\n';
              skillsSection += '  <tbody>\n';

              // ê° ìŠ¤í‚¬ì„ í…Œì´ë¸” í–‰ìœ¼ë¡œ ì¶”ê°€ (ë°°ì§€ í˜•ì‹)
              skillsArray.forEach(skill => {
                const rankBadge = getRankBadge(skill.level);
                const badgeColor = getLanguageBadgeColor(skill.name);
                const logoName = getLanguageLogo(skill.name);

                skillsSection += '    <tr>\n';
                skillsSection += `      <td><img src="https://img.shields.io/badge/${encodeURIComponent(skill.name)}-${badgeColor}?style=flat&logo=${logoName}&logoColor=white"/></td>\n`;
                skillsSection += `      <td>${rankBadge.icon} ${skill.level}%</td>\n`;
                skillsSection += '    </tr>\n';
              });

              // í…Œì´ë¸” ë
              skillsSection += '  </tbody>\n';
              skillsSection += '</table>\n';
            }

            return skillsSection;
          }

          function getLanguageBadgeColor(language) {
            // ë¶„ì•¼ë³„ ìƒ‰ìƒ ì½”ë”©
            const colorMap = {
              // ì›¹ í”„ë¡ íŠ¸ì—”ë“œ (í•‘í¬ê³„ì—´)
              'JavaScript': 'FF69B4',
              'TypeScript': 'FF1493',
              'HTML': 'FFB6C1',
              'CSS': 'FFC0CB',
              'React': 'FFB3D9',
              'Vue': 'FF91A4',

              // ìœ ë‹ˆí‹°/ê²Œì„ (ë³´ë¼ê³„ì—´)
              'C#': '7469B6',
              'Unity': '7469B6',
              'C++': '8B7EC8',

              // ë°±ì—”ë“œ (ë¸”ë£¨ê³„ì—´)
              'Java': '4A90E2',
              'Python': '74C0FC',
              'Node.js': '6495ED',
              'PHP': '5DADE2',
              'Go': '3498DB'
            };

            return colorMap[language] || '95A5A6'; // ê¸°ë³¸ íšŒìƒ‰
          }

          function getLanguageLogo(language) {
            const logoMap = {
              'JavaScript': 'javascript',
              'TypeScript': 'typescript',
              'Python': 'python',
              'Java': 'openjdk',
              'C#': 'c-sharp',
              'C++': 'cplusplus',
              'HTML': 'html5',
              'CSS': 'css3',
              'React': 'react',
              'Vue': 'vue.js',
              'Node.js': 'node.js',
              'Unity': 'unity',
              'PHP': 'php',
              'Go': 'go'
            };

            return logoMap[language] || 'code';
          }
          
          
          async function updateActivitySection() {
            try {
              // activity.json ì½ê¸°
              const activityData = JSON.parse(fs.readFileSync('activity.json', 'utf8'));
              const projects = activityData.projects || [];

              // í˜„ì¬ ë‚ ì§œ
              const now = moment();

              // ì§„í–‰ì¤‘/ì™„ë£Œ í”„ë¡œì íŠ¸ êµ¬ë¶„
              const activeProjects = [];
              const completedProjects = [];

              projects.forEach(project => {
                const endDate = project.end_date ? moment(project.end_date) : null;

                if (!endDate || endDate.isAfter(now)) {
                  // ì§„í–‰ì¤‘
                  activeProjects.push(project);
                } else {
                  // ì™„ë£Œ
                  completedProjects.push(project);
                }
              });

              // ì™„ë£Œ í”„ë¡œì íŠ¸ë¥¼ ì¢…ë£Œì¼ ê¸°ì¤€ ìµœì‹ ìˆœ ì •ë ¬
              completedProjects.sort((a, b) => {
                const dateA = moment(a.end_date || a.start_date);
                const dateB = moment(b.end_date || b.start_date);
                return dateB.diff(dateA);
              });

              // ì§„í–‰ì¤‘ì´ 3ê°œ ë¯¸ë§Œì´ë©´ ì™„ë£Œëœ ê²ƒì—ì„œ ì±„ìš°ê¸°
              let displayProjects = [...activeProjects];
              if (displayProjects.length < 3) {
                const needed = 3 - displayProjects.length;
                displayProjects = displayProjects.concat(completedProjects.slice(0, needed));
              }

              // ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬ (ì‹œì‘ì¼ ê¸°ì¤€)
              displayProjects.sort((a, b) => {
                const dateA = moment(a.start_date);
                const dateB = moment(b.start_date);
                return dateB.diff(dateA);
              });

              // ìƒìœ„ 3ê°œë§Œ
              displayProjects = displayProjects.slice(0, 3);

              // HTML í…Œì´ë¸” ìƒì„±
              let activitySection = '<table width="100%">\n';
              activitySection += '  <thead>\n';
              activitySection += '    <tr>\n';
              activitySection += '      <th width="30%">Project</th>\n';
              activitySection += '      <th width="25%">Stack</th>\n';
              activitySection += '      <th width="45%">Details</th>\n';
              activitySection += '    </tr>\n';
              activitySection += '  </thead>\n';
              activitySection += '  <tbody>\n';

              displayProjects.forEach(project => {
                const projectName = project.link
                  ? `<a href="${project.link}">${project.name}</a>`
                  : project.name;

                activitySection += '    <tr>\n';
                activitySection += `      <td>${projectName}</td>\n`;
                activitySection += `      <td>${project.stack}</td>\n`;
                activitySection += `      <td>${project.description}</td>\n`;
                activitySection += '    </tr>\n';
              });

              activitySection += '  </tbody>\n';
              activitySection += '</table>\n';

              return activitySection;
            } catch (error) {
              console.error('Activity ì„¹ì…˜ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
              // ì—ëŸ¬ ì‹œ ê¸°ë³¸ í…Œì´ë¸” ë°˜í™˜
              return '<table>\n  <tbody>\n    <tr>\n      <td>ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</td>\n    </tr>\n  </tbody>\n</table>\n';
            }
          }
          
          async function updateTechStackTrendTable() {
            const languageStats = await getLanguageStats();
            const excludeLanguages = ['ShaderLab', 'HLSL', 'Makefile', 'Batchfile', 'Shell'];

            // ì–¸ì–´ë“¤ì„ ë¶„ì•¼ë³„ë¡œ ê·¸ë£¹í™”
            const techStacks = {
              ì›¹ê°œë°œ: { languages: ['JavaScript', 'HTML', 'CSS', 'React'], total: 0, growth: 50, logo: 'react', color: 'FF69B4' },
              ë°±ì—”ë“œ: { languages: ['Python', 'Java', 'Node.js'], total: 0, growth: 38, logo: 'server', color: '4A90E2' },
              ê²Œì„ê°œë°œ: { languages: ['C#', 'Unity', 'C++'], total: 0, growth: -32, logo: 'unity', color: '7469B6' }
            };

            // ê° ë¶„ì•¼ë³„ ì‚¬ìš©ëŸ‰ ê³„ì‚°
            Object.entries(languageStats).forEach(([lang, stats]) => {
              if (!excludeLanguages.includes(lang)) {
                Object.values(techStacks).forEach(stack => {
                  if (stack.languages.includes(lang)) {
                    stack.total += stats.bytes || 0;
                  }
                });
              }
            });

            // í…Œì´ë¸” ìƒì„±
            let tableContent = '<table width="100%">\n';
            tableContent += '  <thead>\n';
            tableContent += '    <tr>\n';
            tableContent += '      <th width="70%">Field</th>\n';
            tableContent += '      <th width="30%">Growth</th>\n';
            tableContent += '    </tr>\n';
            tableContent += '  </thead>\n';
            tableContent += '  <tbody>\n';

            // ëª¨ë“  ê¸°ìˆ  ìŠ¤íƒ í‘œì‹œ (ì‚¬ìš©ëŸ‰ ê´€ê³„ì—†ì´)
            const sortedStacks = Object.entries(techStacks)
              .sort(([,a], [,b]) => b.growth - a.growth); // ì„±ì¥ë¥  ìˆœìœ¼ë¡œ ì •ë ¬

            sortedStacks.forEach(([name, stack]) => {
              const growthSign = stack.growth > 0 ? '+' : '';

              tableContent += '    <tr>\n';
              tableContent += `      <td><img src="https://img.shields.io/badge/${encodeURIComponent(name)}-${stack.color}?style=flat&logo=${stack.logo}&logoColor=white"/></td>\n`;
              tableContent += `      <td>${growthSign}${stack.growth}%</td>\n`;
              tableContent += '    </tr>\n';
            });

            tableContent += '  </tbody>\n';
            tableContent += '</table>';

            return tableContent;
          }
          
          function getTechStackDescription(stackName) {
            const descriptions = {
              'ì›¹ê°œë°œ': 'PTAHLABS ì›¹ì‚¬ì´íŠ¸, í”„ë¡œí•„ ìë™í™”',
              'ë°±ì—”ë“œ': 'PTAHLABS API, ë°ì´í„° ì²˜ë¦¬ ì‹œìŠ¤í…œ',
              'TypeScript': 'React í”„ë¡œì íŠ¸, Node.js API',
              'ê²Œì„ê°œë°œ': 'PTAHLABS ê²Œì„, VR/AR í”„ë¡œì íŠ¸'
            };
            return descriptions[stackName] || 'ì§„í–‰ì¤‘ì¸ í”„ë¡œì íŠ¸';
          }
          
          async function main() {
            console.log('í”„ë¡œí•„ ì—…ë°ì´íŠ¸ ì‹œì‘...');

            const [skillsContent, trendContent, activityContent] = await Promise.all([
              updateSkillSection(),
              updateTechStackTrendTable(),
              updateActivitySection()
            ]);

            // README íŒŒì¼ ì½ê¸°
            let readme = fs.readFileSync('README.md', 'utf8');

            // ê° ì„¹ì…˜ ì—…ë°ì´íŠ¸
            readme = readme.replace(
              /<!-- TREND_START -->[\s\S]*?<!-- TREND_END -->/,
              `<!-- TREND_START -->\n${trendContent}\n<!-- TREND_END -->`
            );

            readme = readme.replace(
              /<!-- SKILL_START -->[\s\S]*?<!-- SKILL_END -->/,
              `<!-- SKILL_START -->\n${skillsContent}<!-- SKILL_END -->`
            );

            readme = readme.replace(
              /<!-- ACTIVITY_START -->[\s\S]*?<!-- ACTIVITY_END -->/,
              `<!-- ACTIVITY_START -->\n${activityContent}<!-- ACTIVITY_END -->`
            );

            // ì—…ë°ì´íŠ¸ ì‹œê°„ ê°±ì‹ 
            const now = moment().utcOffset(9).format('YYYY-MM-DD HH:mm');
            readme = readme.replace(
              /<!-- UPDATE_TIME -->.*?<!-- \/UPDATE_TIME -->/,
              `<!-- UPDATE_TIME -->${now} KST<!-- /UPDATE_TIME -->`
            );

            // íŒŒì¼ ì €ì¥
            fs.writeFileSync('README.md', readme);
            console.log('í”„ë¡œí•„ ì—…ë°ì´íŠ¸ ì™„ë£Œ!');
          }
          
          main().catch(console.error);
          EOF
          
          node analyze-skills.js
          
      - name: Commit and Push Changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git pull origin main
          git add README.md
          git diff --staged --quiet || git commit -m "Auto-update profile with latest stats [skip ci]"
          git push