name: Generate Language Trend Charts

on:
  schedule:
    # ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 9ì‹œ (ì¼ìš”ì¼ UTC 24:00)
    - cron: '0 0 * * 1'
  workflow_dispatch:

jobs:
  generate-charts:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          
      - name: Install Dependencies
        run: |
          pip install matplotlib seaborn pandas requests python-dateutil
          
      - name: Generate Language Trend Charts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          USERNAME: ${{ github.repository_owner }}
        run: |
          cat > generate_charts.py << 'EOF'
          import matplotlib.pyplot as plt
          import seaborn as sns
          import pandas as pd
          import requests
          import json
          from datetime import datetime, timedelta
          import os
          from collections import defaultdict
          import numpy as np
          
          # GitHub API ì„¤ì •
          GITHUB_TOKEN = os.environ['GITHUB_TOKEN']
          USERNAME = os.environ['USERNAME']
          
          headers = {
              'Authorization': f'token {GITHUB_TOKEN}',
              'Accept': 'application/vnd.github.v3+json'
          }
          
          # ì–¸ì–´ë³„ ìƒ‰ìƒ ë§¤í•‘
          language_colors = {
              'JavaScript': '#f7df1e',
              'TypeScript': '#3178c6',
              'Python': '#3776ab',
              'Java': '#ed8b00',
              'C#': '#239120',
              'Unity': '#000000',
              'HTML': '#e34f26',
              'CSS': '#1572b6',
              'React': '#61dafb',
              'Vue': '#4fc08d',
              'PHP': '#777bb4',
              'Go': '#00add8',
              'Rust': '#dea584',
              'Swift': '#fa7343',
              'Kotlin': '#7f52ff'
          }
          
          def get_monthly_language_data():
              """ì§€ë‚œ 12ê°œì›”ê°„ ì–¸ì–´ë³„ ì‚¬ìš©ë¥  ë°ì´í„° ìˆ˜ì§‘"""
              print("ğŸ“Š ì›”ë³„ ì–¸ì–´ ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘...")
              
              # ì§€ë‚œ 12ê°œì›” ìƒì„±
              months = []
              current_date = datetime.now()
              for i in range(12):
                  month_date = current_date - timedelta(days=30*i)
                  months.append(month_date.strftime('%Y-%m'))
              months.reverse()
              
              # ì›”ë³„ ì–¸ì–´ ë°ì´í„° ì €ì¥
              monthly_data = defaultdict(lambda: defaultdict(int))
              
              try:
                  # ì‚¬ìš©ìì˜ ëª¨ë“  ë¦¬í¬ì§€í† ë¦¬ ê°€ì ¸ì˜¤ê¸°
                  repos_response = requests.get(
                      f'https://api.github.com/users/{USERNAME}/repos?per_page=100&sort=updated',
                      headers=headers
                  )
                  repos = repos_response.json()
                  
                  for repo in repos[:20]:  # ìµœê·¼ ì—…ë°ì´íŠ¸ëœ 20ê°œ ë¦¬í¬ë§Œ
                      if repo['fork']:
                          continue
                          
                      print(f"ë¶„ì„ ì¤‘: {repo['name']}")
                      
                      # ê° ë¦¬í¬ì§€í† ë¦¬ì˜ ì–¸ì–´ í†µê³„
                      try:
                          lang_response = requests.get(
                              f"https://api.github.com/repos/{USERNAME}/{repo['name']}/languages",
                              headers=headers
                          )
                          languages = lang_response.json()
                          
                          # ë¦¬í¬ì§€í† ë¦¬ ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê°„ìœ¼ë¡œ ì›” íŒë‹¨
                          updated_at = datetime.strptime(repo['updated_at'], '%Y-%m-%dT%H:%M:%SZ')
                          month_key = updated_at.strftime('%Y-%m')
                          
                          if month_key in months:
                              total_bytes = sum(languages.values())
                              for lang, bytes_count in languages.items():
                                  percentage = (bytes_count / total_bytes * 100) if total_bytes > 0 else 0
                                  monthly_data[month_key][lang] += percentage
                                  
                      except Exception as e:
                          print(f"ì–¸ì–´ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨ {repo['name']}: {e}")
                          continue
                          
              except Exception as e:
                  print(f"ë¦¬í¬ì§€í† ë¦¬ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: {e}")
                  
              # ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš° ìƒ˜í”Œ ë°ì´í„° ìƒì„±
              if not monthly_data:
                  print("âš ï¸  ì‹¤ì œ ë°ì´í„°ê°€ ì—†ì–´ì„œ ìƒ˜í”Œ ë°ì´í„°ë¡œ ì°¨íŠ¸ ìƒì„±")
                  monthly_data = generate_sample_data(months)
              
              return months, monthly_data
          
          def generate_sample_data(months):
              """ìƒ˜í”Œ ë°ì´í„° ìƒì„± (ì‹¤ì œ ë°ì´í„°ê°€ ì—†ì„ ë•Œ)"""
              languages = ['JavaScript', 'Python', 'TypeScript', 'C#', 'Unity']
              sample_data = defaultdict(lambda: defaultdict(int))
              
              # ì‹¤ì œì™€ ë¹„ìŠ·í•œ íŒ¨í„´ìœ¼ë¡œ ìƒ˜í”Œ ë°ì´í„° ìƒì„±
              base_values = {
                  'JavaScript': 45,
                  'Python': 25,
                  'TypeScript': 15,
                  'C#': 60,  # ê³¼ê±°ì— ë†’ì•˜ë‹¤ê°€ ê°ì†Œ
                  'Unity': 55   # C#ê³¼ ë¹„ìŠ·í•œ íŒ¨í„´
              }
              
              for i, month in enumerate(months):
                  for lang in languages:
                      base = base_values[lang]
                      
                      # C#, UnityëŠ” ì‹œê°„ì´ ì§€ë‚ ìˆ˜ë¡ ê°ì†Œ (ê²Œì„ ê°œë°œ â†’ ì›¹ ê°œë°œ)
                      if lang in ['C#', 'Unity']:
                          trend = -2.5 * i  # ì›”ë§ˆë‹¤ 2.5% ê°ì†Œ
                      # JavaScript, Python, TypeScriptëŠ” ì¦ê°€
                      else:
                          trend = 1.5 * i   # ì›”ë§ˆë‹¤ 1.5% ì¦ê°€
                      
                      # ëœë¤ ë³€ë™ ì¶”ê°€
                      noise = np.random.normal(0, 3)
                      value = max(0, min(100, base + trend + noise))
                      
                      sample_data[month][lang] = value
              
              return sample_data
          
          def create_trend_chart(months, monthly_data):
              """ì–¸ì–´ íŠ¸ë Œë“œ ì°¨íŠ¸ ìƒì„±"""
              print("ğŸ¨ íŠ¸ë Œë“œ ì°¨íŠ¸ ìƒì„± ì¤‘...")
              
              # ìŠ¤íƒ€ì¼ ì„¤ì •
              plt.style.use('dark_background')
              sns.set_palette("husl")
              
              fig, ax = plt.subplots(figsize=(12, 8))
              fig.patch.set_facecolor('#20232a')
              ax.set_facecolor('#20232a')
              
              # ì£¼ìš” ì–¸ì–´ë“¤ë§Œ ì„ íƒ (ë°ì´í„°ê°€ ìˆëŠ” ì–¸ì–´ë“¤)
              all_languages = set()
              for month_data in monthly_data.values():
                  all_languages.update(month_data.keys())
              
              # í‰ê·  ì‚¬ìš©ë¥ ë¡œ ì •ë ¬í•´ì„œ ìƒìœ„ 5ê°œ ì–¸ì–´ë§Œ
              lang_averages = {}
              for lang in all_languages:
                  values = [monthly_data[month].get(lang, 0) for month in months]
                  lang_averages[lang] = sum(values) / len(values)
              
              top_languages = sorted(lang_averages.items(), key=lambda x: x[1], reverse=True)[:5]
              
              # ê° ì–¸ì–´ë³„ ì„  ê·¸ë˜í”„
              for lang, _ in top_languages:
                  values = [monthly_data[month].get(lang, 0) for month in months]
                  color = language_colors.get(lang, '#ffffff')
                  
                  ax.plot(range(len(months)), values, 
                         marker='o', linewidth=2.5, markersize=6,
                         label=lang, color=color, alpha=0.9)
              
              # ì°¨íŠ¸ ìŠ¤íƒ€ì¼ë§
              ax.set_xticks(range(len(months)))
              ax.set_xticklabels([month.split('-')[1] + 'ì›”' for month in months], 
                               color='#ffffff', fontsize=10)
              ax.set_ylabel('ì‚¬ìš©ë¥  (%)', color='#52b788', fontsize=12, fontweight='bold')
              ax.set_title('ì›”ë³„ í”„ë¡œê·¸ë˜ë° ì–¸ì–´ íŠ¸ë Œë“œ', color='#52b788', 
                          fontsize=16, fontweight='bold', pad=20)
              
              # ê·¸ë¦¬ë“œ ë° ë²”ë¡€
              ax.grid(True, alpha=0.3, color='#555555')
              ax.legend(loc='upper left', frameon=True, fancybox=True, 
                       shadow=True, ncol=1, fontsize=10)
              
              # ì¶• ìƒ‰ìƒ
              ax.tick_params(axis='y', colors='#ffffff')
              ax.spines['bottom'].set_color('#555555')
              ax.spines['left'].set_color('#555555')
              ax.spines['top'].set_visible(False)
              ax.spines['right'].set_visible(False)
              
              # Yì¶• ë²”ìœ„ ì„¤ì •
              ax.set_ylim(0, 100)
              
              plt.tight_layout()
              plt.savefig('language_trend_chart.png', dpi=300, bbox_inches='tight', 
                         facecolor='#20232a', edgecolor='none')
              plt.close()
              
              print("âœ… ì°¨íŠ¸ ìƒì„± ì™„ë£Œ: language_trend_chart.png")
          
          def create_growth_chart(months, monthly_data):
              """ì„±ì¥ë¥  ì°¨íŠ¸ ìƒì„±"""
              print("ğŸ“ˆ ì„±ì¥ë¥  ì°¨íŠ¸ ìƒì„± ì¤‘...")
              
              fig, ax = plt.subplots(figsize=(12, 6))
              fig.patch.set_facecolor('#20232a')
              ax.set_facecolor('#20232a')
              
              # ì£¼ìš” ì–¸ì–´ë“¤ì˜ ì„±ì¥ë¥  ê³„ì‚°
              all_languages = set()
              for month_data in monthly_data.values():
                  all_languages.update(month_data.keys())
              
              growth_data = {}
              for lang in all_languages:
                  values = [monthly_data[month].get(lang, 0) for month in months]
                  if len(values) >= 2 and values[0] > 0:
                      growth_rate = ((values[-1] - values[0]) / values[0]) * 100
                      growth_data[lang] = growth_rate
              
              # ì„±ì¥ë¥  ìˆœìœ¼ë¡œ ì •ë ¬
              sorted_growth = sorted(growth_data.items(), key=lambda x: x[1], reverse=True)[:8]
              
              languages = [item[0] for item in sorted_growth]
              growth_rates = [item[1] for item in sorted_growth]
              
              # ìƒ‰ìƒ ì„¤ì • (ì–‘ìˆ˜ëŠ” ì´ˆë¡, ìŒìˆ˜ëŠ” ë¹¨ê°•)
              colors = ['#52b788' if rate >= 0 else '#e74c3c' for rate in growth_rates]
              
              bars = ax.barh(languages, growth_rates, color=colors, alpha=0.8)
              
              # ë°” ìœ„ì— ìˆ˜ì¹˜ í‘œì‹œ
              for i, bar in enumerate(bars):
                  width = bar.get_width()
                  ax.text(width + (2 if width >= 0 else -2), bar.get_y() + bar.get_height()/2,
                         f'{growth_rates[i]:+.1f}%', ha='left' if width >= 0 else 'right',
                         va='center', color='white', fontweight='bold')
              
              ax.set_xlabel('ì„±ì¥ë¥  (%)', color='#52b788', fontsize=12, fontweight='bold')
              ax.set_title('ì–¸ì–´ë³„ ì—°ê°„ ì„±ì¥ë¥ ', color='#52b788', 
                          fontsize=16, fontweight='bold', pad=20)
              ax.axvline(0, color='#555555', linewidth=1)
              ax.grid(True, alpha=0.3, color='#555555', axis='x')
              
              # ì¶• ìƒ‰ìƒ
              ax.tick_params(axis='both', colors='#ffffff')
              ax.spines['bottom'].set_color('#555555')
              ax.spines['left'].set_color('#555555')
              ax.spines['top'].set_visible(False)
              ax.spines['right'].set_visible(False)
              
              plt.tight_layout()
              plt.savefig('language_growth_chart.png', dpi=300, bbox_inches='tight',
                         facecolor='#20232a', edgecolor='none')
              plt.close()
              
              print("âœ… ì„±ì¥ë¥  ì°¨íŠ¸ ìƒì„± ì™„ë£Œ: language_growth_chart.png")
          
          def main():
              print("ğŸš€ ì–¸ì–´ íŠ¸ë Œë“œ ì°¨íŠ¸ ìƒì„± ì‹œì‘...")
              
              months, monthly_data = get_monthly_language_data()
              
              if monthly_data:
                  create_trend_chart(months, monthly_data)
                  create_growth_chart(months, monthly_data)
                  
                  print("ğŸ‰ ëª¨ë“  ì°¨íŠ¸ ìƒì„± ì™„ë£Œ!")
                  print("ğŸ“ ìƒì„±ëœ íŒŒì¼:")
                  print("  - language_trend_chart.png")
                  print("  - language_growth_chart.png")
              else:
                  print("âŒ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ì–´ì„œ ì°¨íŠ¸ ìƒì„± ì‹¤íŒ¨")
          
          if __name__ == "__main__":
              main()
          EOF
          
          python generate_charts.py
          
      - name: Update README with Charts
        run: |
          # READMEì— ì°¨íŠ¸ ì´ë¯¸ì§€ ë§í¬ ì—…ë°ì´íŠ¸
          if [ -f "language_trend_chart.png" ]; then
            # ì´ë¯¸ì§€ë¥¼ assets í´ë”ë¡œ ì´ë™
            mkdir -p assets
            mv language_trend_chart.png assets/
            mv language_growth_chart.png assets/
            
            # README ì—…ë°ì´íŠ¸
            sed -i 's|<!-- TREND_CHART -->.*<!-- /TREND_CHART -->|<!-- TREND_CHART -->\n![Language Trends](./assets/language_trend_chart.png)\n<!-- /TREND_CHART -->|g' README.md
            sed -i 's|<!-- GROWTH_CHART -->.*<!-- /GROWTH_CHART -->|<!-- GROWTH_CHART -->\n![Growth Chart](./assets/language_growth_chart.png)\n<!-- /GROWTH_CHART -->|g' README.md
            
            echo "âœ… README ì—…ë°ì´íŠ¸ ì™„ë£Œ"
          fi
          
      - name: Commit and Push Charts
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add assets/ README.md
          git diff --staged --quiet || git commit -m "Update language trend charts"
          git push